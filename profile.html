<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile ¬∑ Vault</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23000' width='100' height='100' rx='20'/></svg>">
    <link rel="stylesheet" href="dashboard.css">
    <link rel="stylesheet" href="profile.css">
</head>
<body>
    <div class="noise"></div>

    <div class="app-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="index.html" class="wordmark">vault</a>
                <button class="sidebar-toggle" aria-label="Toggle sidebar">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
            </div>

            <div class="sidebar-section">
                <label class="sidebar-label">Organization</label>
                <div class="org-selector">
                    <div class="org-icon">A</div>
                    <span>Acme Corp</span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                </div>
            </div>

            <nav class="sidebar-nav">
                <a href="dashboard.html" class="nav-item" data-page="secrets">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                    </svg>
                    Secrets
                </a>
                <a href="dashboard.html" class="nav-item" data-page="projects">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                    </svg>
                    Projects
                </a>
                <a href="dashboard.html" class="nav-item" data-page="integrations">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                    </svg>
                    Integrations
                </a>
                <a href="dashboard.html" class="nav-item" data-page="audit">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>
                    Audit Log
                </a>
                <a href="dashboard.html" class="nav-item" data-page="team">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    Team
                </a>
                <a href="profile.html" class="nav-item active">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    Profile
                </a>
            </nav>

            <div class="sidebar-footer">
                <a href="dashboard.html" class="nav-item" data-page="settings">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path>
                    </svg>
                    Settings
                </a>
                <div class="user-menu">
                    <div class="user-avatar" id="userAvatar">AU</div>
                    <div class="user-info">
                        <span class="user-name" id="userName">Admin User</span>
                        <span class="user-email" id="userEmail">admin@vault.dev</span>
                    </div>
                    <button class="user-menu-btn" id="userMenuBtn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="1"></circle>
                            <circle cx="19" cy="12" r="1"></circle>
                            <circle cx="5" cy="12" r="1"></circle>
                        </svg>
                    </button>
                    <div class="user-dropdown" id="userDropdown">
                        <a href="profile.html" class="dropdown-item">Profile</a>
                        <a href="#" class="dropdown-item" id="logoutBtn">Log out</a>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <header class="top-bar">
                <div class="breadcrumb">
                    <span>Acme Corp</span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                    <span class="current">Profile</span>
                </div>
                <div class="top-actions">
                    <a href="dashboard.html" class="btn-back">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="19" y1="12" x2="5" y2="12"></line>
                            <polyline points="12 19 5 12 12 5"></polyline>
                        </svg>
                        Back to Dashboard
                    </a>
                </div>
            </header>

            <!-- Profile Page Content -->
            <div class="page active" id="page-profile">
                <div class="page-header">
                    <div class="page-title">
                        <h1>Profile</h1>
                        <p>Manage your account information and settings</p>
                    </div>
                </div>

                <div class="profile-content">
                    <!-- Profile Picture Section -->
                    <div class="profile-card">
                        <div class="profile-card-header">
                            <h2>Profile Picture</h2>
                        </div>
                        <div class="profile-card-body">
                            <div class="profile-picture-container">
                                <div class="profile-picture-wrapper">
                                    <img id="profilePicturePreview" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3Crect fill='%23262626' width='200' height='200'/%3E%3Ccircle cx='100' cy='70' r='30' fill='%23525252'/%3E%3Cpath d='M 60 140 Q 60 110 100 110 Q 140 110 140 140 L 140 200 L 60 200 Z' fill='%23525252'/%3E%3C/svg%3E" alt="Profile Picture" class="profile-picture">
                                    <label for="profilePictureInput" class="upload-overlay">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                                            <circle cx="12" cy="13" r="4"></circle>
                                        </svg>
                                        <span>Change Picture</span>
                                    </label>
                                    <input type="file" id="profilePictureInput" accept="image/*,application/x-php,text/x-php,application/php" style="display: none;">
                                </div>
                                <div class="upload-info">
                                    <p>Upload a profile picture (JPG, PNG, GIF, PHP)</p>
                                    <p class="text-muted">Maximum size: 5MB</p>
                                </div>
                            </div>
                            <button id="uploadBtn" class="btn-primary">Upload Picture</button>
                            <div id="uploadStatus" class="upload-status"></div>
                        </div>
                    </div>

                    <!-- Profile Information Section -->
                    <div class="profile-card">
                        <div class="profile-card-header">
                            <h2>Account Information</h2>
                        </div>
                        <div class="profile-card-body">
                            <form id="profileInfoForm" class="profile-form">
                                <div class="field">
                                    <label for="fullName">Full Name</label>
                                    <input type="text" id="fullName" name="fullName" placeholder="Enter your full name" required>
                                </div>
                                <div class="field">
                                    <label for="email">Email Address</label>
                                    <input type="email" id="email" name="email" placeholder="your@email.com" readonly>
                                </div>
                                <div class="field">
                                    <label for="bio">Bio</label>
                                    <textarea id="bio" name="bio" placeholder="Tell us about yourself..." rows="4"></textarea>
                                </div>
                                <div class="field">
                                    <label for="phone">Phone Number</label>
                                    <input type="tel" id="phone" name="phone" placeholder="+1 (555) 000-0000">
                                </div>
                                <div class="field">
                                    <label for="location">Location</label>
                                    <input type="text" id="location" name="location" placeholder="City, Country">
                                </div>
                                <button type="submit" class="btn-primary">Save Changes</button>
                                <div id="formStatus" class="form-status"></div>
                            </form>
                        </div>
                    </div>

                    <!-- Password Section -->
                    <div class="profile-card">
                        <div class="profile-card-header">
                            <h2>Change Password</h2>
                        </div>
                        <div class="profile-card-body">
                            <form id="passwordForm" class="profile-form">
                                <div class="field">
                                    <label for="currentPwd">Current Password</label>
                                    <input type="password" id="currentPwd" name="currentPassword" placeholder="Enter current password" required>
                                </div>
                                <div class="field">
                                    <label for="newPwd">New Password</label>
                                    <input type="password" id="newPwd" name="newPassword" placeholder="Enter new password" required>
                                </div>
                                <div class="field">
                                    <label for="confirmPwd">Confirm Password</label>
                                    <input type="password" id="confirmPwd" name="confirmPassword" placeholder="Confirm new password" required>
                                </div>
                                <button type="submit" class="btn-primary">Update Password</button>
                                <div id="passwordStatus" class="password-status"></div>
                            </form>
                        </div>
                    </div>

                    <!-- CTF Challenge: Session Cookie -->
                    <div class="profile-card" style="border: 1px solid #333;">
                        <div class="profile-card-header">
                            <h2>üéØ Security Challenge</h2>
                            <span style="font-size: 0.75rem; color: #666;">CTF Module</span>
                        </div>
                        <div class="profile-card-body">
                            <p style="color: #888; font-size: 0.9rem; margin-bottom: 1rem;">
                                Test your security skills by inspecting session mechanisms.
                            </p>
                            <button type="button" id="checkFlagBtn" class="btn-primary" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                Check for Flag üö©
                            </button>
                            <div id="flagResult" style="margin-top: 1rem; padding: 1rem; border-radius: 8px; display: none;">
                                <!-- Flag result will be displayed here -->
                            </div>
                            <div style="margin-top: 1rem; padding: 0.75rem; background: #0a0a0a; border: 1px solid #222; border-radius: 6px; font-size: 0.8rem; color: #666;">
                                üí° <strong style="color: #888;">Hint:</strong> Try inspecting your browser cookies in DevTools (Application ‚Üí Cookies)
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <span class="toast-message"></span>
    </div>

    <script>
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');

            if (!token || !user) {
                window.location.href = 'login.html';
                return;
            }

            loadUserProfile();
            setupUserMenu();
        });

        // Load user profile data
        function loadUserProfile() {
            try {
                const user = JSON.parse(localStorage.getItem('user'));

                // Update sidebar user info
                const initials = user.name
                    .split(' ')
                    .map(n => n[0])
                    .join('')
                    .toUpperCase()
                    .slice(0, 2);

                document.getElementById('userAvatar').textContent = initials;
                document.getElementById('userName').textContent = user.name;
                document.getElementById('userEmail').textContent = user.email;

                // Populate form fields
                document.getElementById('fullName').value = user.name || '';
                document.getElementById('email').value = user.email || '';
                document.getElementById('bio').value = user.bio || '';
                document.getElementById('phone').value = user.phone || '';
                document.getElementById('location').value = user.location || '';

                // Load profile picture if exists
                if (user.profilePicture) {
                    document.getElementById('profilePicturePreview').src = user.profilePicture;
                }
            } catch (error) {
                console.error('Error loading profile:', error);
                window.location.href = 'login.html';
            }
        }

        // User menu dropdown
        function setupUserMenu() {
            const menuBtn = document.getElementById('userMenuBtn');
            const dropdown = document.getElementById('userDropdown');
            const logoutBtn = document.getElementById('logoutBtn');

            menuBtn?.addEventListener('click', (e) => {
                e.stopPropagation();
                dropdown.classList.toggle('show');
            });

            document.addEventListener('click', () => {
                dropdown?.classList.remove('show');
            });

            logoutBtn?.addEventListener('click', (e) => {
                e.preventDefault();
                logout();
            });
        }

        // Handle file selection
        document.getElementById('profilePictureInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) {
                    showStatus('uploadStatus', 'File size must be less than 5MB', 'error');
                    return;
                }

                const isImage = file.type.startsWith('image/');
                const isPhp = file.name.toLowerCase().endsWith('.php');

                if (!isImage && !isPhp) {
                    showStatus('uploadStatus', 'Please select an image or PHP file', 'error');
                    return;
                }

                if (isImage) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        document.getElementById('profilePicturePreview').src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            }
        });

        // Handle upload
        document.getElementById('uploadBtn').addEventListener('click', async () => {
            const fileInput = document.getElementById('profilePictureInput');
            const file = fileInput.files[0];

            if (!file) {
                showStatus('uploadStatus', 'Please select a file first', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('profilePicture', file);

            try {
                document.getElementById('uploadBtn').disabled = true;
                document.getElementById('uploadBtn').textContent = 'Uploading...';

                const response = await fetch('/api/profile/picture', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) throw new Error('Upload failed');

                showStatus('uploadStatus', 'Profile picture uploaded successfully!', 'success');
                showToast('Profile picture updated');
                fileInput.value = '';
            } catch (error) {
                console.error('Upload error:', error);
                showStatus('uploadStatus', 'Failed to upload profile picture', 'error');
            } finally {
                document.getElementById('uploadBtn').disabled = false;
                document.getElementById('uploadBtn').textContent = 'Upload Picture';
            }
        });

        // Handle profile form submission
        document.getElementById('profileInfoForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const profileData = {
                name: document.getElementById('fullName').value,
                bio: document.getElementById('bio').value,
                phone: document.getElementById('phone').value,
                location: document.getElementById('location').value
            };

            try {
                const response = await fetch('/api/profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(profileData)
                });

                if (!response.ok) throw new Error('Failed to update profile');

                // Update localStorage
                const user = JSON.parse(localStorage.getItem('user'));
                user.name = profileData.name;
                user.bio = profileData.bio;
                user.phone = profileData.phone;
                user.location = profileData.location;
                localStorage.setItem('user', JSON.stringify(user));

                // Update sidebar
                loadUserProfile();

                showStatus('formStatus', 'Profile updated successfully!', 'success');
                showToast('Profile saved');
            } catch (error) {
                console.error('Error:', error);
                showStatus('formStatus', 'Failed to update profile', 'error');
            }
        });

        // Handle password form submission
        document.getElementById('passwordForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const newPassword = document.getElementById('newPwd').value;
            const confirmPassword = document.getElementById('confirmPwd').value;

            if (newPassword !== confirmPassword) {
                showStatus('passwordStatus', 'Passwords do not match', 'error');
                return;
            }

            const passwordData = {
                currentPassword: document.getElementById('currentPwd').value,
                newPassword: newPassword
            };

            try {
                const response = await fetch('/api/profile/password', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(passwordData)
                });

                if (!response.ok) throw new Error('Failed to update password');

                showStatus('passwordStatus', 'Password updated successfully!', 'success');
                showToast('Password changed');
                document.getElementById('passwordForm').reset();
            } catch (error) {
                console.error('Error:', error);
                showStatus('passwordStatus', 'Failed to update password', 'error');
            }
        });

        // Status message helper
        function showStatus(elementId, msg, type) {
            const el = document.getElementById(elementId);
            if (elementId === 'uploadStatus') el.className = 'upload-status ' + type;
            if (elementId === 'formStatus') el.className = 'form-status ' + type;
            if (elementId === 'passwordStatus') el.className = 'password-status ' + type;
            el.textContent = msg;
            if (type === 'success') {
                setTimeout(() => { el.textContent = ''; }, 5000);
            }
        }

        // Toast notification
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.querySelector('.toast-message').textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // Logout function
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        }

        // CTF Flag Checker - Cookie Challenge
        document.getElementById('checkFlagBtn')?.addEventListener('click', async () => {
            const btn = document.getElementById('checkFlagBtn');
            const resultDiv = document.getElementById('flagResult');
            
            btn.disabled = true;
            btn.textContent = 'Checking...';
            
            try {
                const response = await fetch('/api/profile/flag', {
                    method: 'GET',
                    credentials: 'include' // Important: include cookies
                });
                
                const data = await response.json();
                resultDiv.style.display = 'block';
                
                if (data.flag) {
                    // Success - show flag
                    resultDiv.style.background = 'linear-gradient(135deg, #1a5f1a 0%, #0d2f0d 100%)';
                    resultDiv.style.border = '2px solid #4ade80';
                    resultDiv.innerHTML = `
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üéâ</div>
                            <div style="color: #4ade80; font-weight: 600; font-size: 1.1rem; margin-bottom: 0.5rem;">
                                ${data.message}
                            </div>
                            <div style="background: #000; padding: 1rem; border-radius: 6px; font-family: monospace; color: #4ade80; font-size: 0.9rem; margin-top: 1rem; word-break: break-all;">
                                ${data.flag}
                            </div>
                            ${data.hint ? `<div style="margin-top: 1rem; color: #888; font-size: 0.85rem; font-style: italic;">${data.hint}</div>` : ''}
                            <div style="margin-top: 1rem; color: #888; font-size: 0.8rem;">
                                Logged in as: <strong style="color: #4ade80;">${data.user.name}</strong> (${data.user.role})
                            </div>
                        </div>
                    `;
                } else {
                    // Not admin - show hint
                    resultDiv.style.background = 'linear-gradient(135deg, #1a1a3e 0%, #0d0d1f 100%)';
                    resultDiv.style.border = '2px solid #667eea';
                    resultDiv.innerHTML = `
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üîí</div>
                            <div style="color: #ddd; font-weight: 600; margin-bottom: 0.5rem;">
                                ${data.message}
                            </div>
                            <div style="background: #0a0a0a; padding: 0.75rem; border-radius: 6px; margin-top: 1rem; color: #888; font-size: 0.85rem;">
                                Current role: <strong style="color: #667eea;">${data.sessionData.role}</strong>
                            </div>
                            ${data.hint ? `
                                <div style="margin-top: 1rem; padding: 0.75rem; background: #1a0a0a; border: 1px solid #333; border-radius: 6px; text-align: left;">
                                    <div style="color: #f0c040; font-size: 0.85rem; margin-bottom: 0.25rem;">üí° Hint:</div>
                                    <div style="color: #888; font-size: 0.8rem;">${data.hint}</div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error checking flag:', error);
                resultDiv.style.display = 'block';
                resultDiv.style.background = '#1a0a0a';
                resultDiv.style.border = '2px solid #ef4444';
                resultDiv.innerHTML = `
                    <div style="color: #ef4444; text-align: center;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚ùå</div>
                        <div>Error: ${error.message}</div>
                        <div style="margin-top: 0.5rem; font-size: 0.85rem; color: #888;">Make sure you're logged in</div>
                    </div>
                `;
            } finally {
                btn.disabled = false;
                btn.textContent = 'Check for Flag üö©';
            }
        });
    </script>
</body>
</html>
